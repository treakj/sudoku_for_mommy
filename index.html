<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo de Sudoku</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
        }

        body.lang-ja {
            font-family: 'Noto Sans JP', sans-serif;
        }

        body.lang-pt,
        body.lang-en {
            font-family: 'Inter', sans-serif;
        }

        .canvas-container {
            width: 100%;
            max-width: 600px;
            aspect-ratio: 1 / 1;
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
            border-radius: 0.5rem;
        }

        .btn-difficulty.active {
            background-color: #1E40AF;
            color: white;
            border-color: #1E40AF;
        }

        #loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .btn-action:disabled {
            background-color: #9CA3AF;
            cursor: not-allowed;
        }

        /* Estilos para o menu "Como Jogar" */
        .controls-info-panel {
            margin: 1rem 0;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .controls-info {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            overflow: hidden;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .controls-info[open] {
            border-color: #3b82f6;
            box-shadow: 0 10px 25px -3px rgba(59, 130, 246, 0.1);
        }

        .controls-summary {
            padding: 1rem 1.5rem;
            cursor: pointer;
            font-weight: 600;
            color: #374151;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: none;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            user-select: none;
        }

        .controls-summary:hover {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        }

        .controls-summary::-webkit-details-marker {
            display: none;
        }

        .controls-summary::before {
            content: '‚ñ∂';
            margin-right: 0.5rem;
            transition: transform 0.3s ease;
        }

        .controls-info[open] .controls-summary::before {
            transform: rotate(90deg);
        }

        .controls-content {
            padding: 1.5rem;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .control-section {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid #3b82f6;
        }

        .control-section h4 {
            font-size: 1rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .control-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
            gap: 0.5rem;
        }

        .control-section li {
            padding: 0.375rem 0;
            color: #4b5563;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            transition: color 0.2s ease;
        }

        .control-section li::before {
            content: '‚Ä¢';
            color: #3b82f6;
            margin-right: 0.5rem;
            font-weight: bold;
        }

        .control-section kbd {
            background-color: #374151;
            color: white;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-family: 'Courier New', monospace;
            margin: 0 0.125rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        @media (max-width: 768px) {
            .controls-content {
                grid-template-columns: 1fr;
                gap: 1rem;
                padding: 1rem;
            }

            .control-section {
                padding: 0.75rem;
            }

            .control-section h4 {
                font-size: 0.9rem;
            }

            .control-section li {
                font-size: 0.8rem;
                padding: 0.25rem 0;
            }

            .controls-summary {
                padding: 0.75rem 1rem;
                font-size: 1rem;
            }
        }

        /* Estilos para o sistema de notas */
        .notes-toggle-btn.notes-active,
        #notes-btn.notes-active {
            background-color: #7c3aed !important;
            box-shadow: 0 0 0 2px #a855f7;
            transform: scale(1.05);
        }

        .cell-notes {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 1px;
            pointer-events: none;
            z-index: 1;
        }

        .note-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: 500;
            color: #6b7280;
            background: transparent;
        }

        .note-cell.note-active {
            color: #374151;
            font-weight: 600;
        }

        .has-notes {
            position: relative;
        }

        .has-notes .cell-number {
            z-index: 2;
            position: relative;
        }

        .notes-active {
            background-color: rgba(139, 92, 246, 0.1) !important;
            border: 2px solid #8b5cf6 !important;
        }

        /* Estilos para bot√µes de idioma */
        .lang-btn.active {
            background-color: #1E40AF !important;
            color: white !important;
            transform: scale(1.05);
        }

        .lang-btn {
            min-width: 32px;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto">
        <header class="text-center mb-4 relative">
            <h1 id="main-title" class="text-3xl md:text-4xl font-bold text-gray-900">Jogo de Sudoku</h1>
            <p id="subtitle" class="text-gray-600 mt-1">Desafie sua l√≥gica e divirta-se!</p>
            
            <!-- Indica√ß√µes de Controle -->
            <div class="controls-info-panel mt-4">
                <details class="controls-info">
                    <summary class="controls-summary">‚ÑπÔ∏è Como Jogar</summary>
                    <div class="controls-content">
                        <div class="control-section">
                            <h4>‚å®Ô∏è Teclado</h4>
                            <ul>
                                <li><kbd>1-9</kbd> Inserir n√∫meros</li>
                                <li><kbd>Shift</kbd> + <kbd>1-9</kbd> Modo notas</li>
                                <li><kbd>Ctrl+Z</kbd> Desfazer</li>
                                <li><kbd>Ctrl+Y</kbd> Refazer</li>
                                <li><kbd>H</kbd> Dica</li>
                                <li><kbd>Delete</kbd> Apagar</li>
                                <li><kbd>‚Üë‚Üì‚Üê‚Üí</kbd> Navegar</li>
                            </ul>
                        </div>
                        <div class="control-section">
                            <h4>üñ±Ô∏è Mouse/Touch</h4>
                            <ul>
                                <li>Clique para selecionar c√©lula</li>
                                <li>Clique em n√∫mero para destacar</li>
                                <li>Mobile: Use painel inferior</li>
                            </ul>
                        </div>
                        <div class="control-section">
                            <h4>üéØ Recursos</h4>
                            <ul>
                                <li>üî¢ Contador de n√∫meros (canto)</li>
                                <li>üìù Sistema de notas</li>
                                <li>üìö Hist√≥rico completo</li>
                                <li>üí° Dicas inteligentes</li>
                                <li>üé® Destaque autom√°tico</li>
                            </ul>
                        </div>
                    </div>
                </details>
            </div>
            
            <button id="lang-toggle" style="display: none;"
                class="absolute top-0 right-0 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition-colors">
                PT
            </button>
            
            <div class="absolute top-0 right-0 flex gap-1">
                <button id="lang-pt" class="lang-btn bg-blue-500 text-white px-2 py-1 rounded text-sm font-semibold hover:bg-blue-600 transition-colors" data-lang="pt">PT</button>
                <button id="lang-en" class="lang-btn bg-gray-300 text-gray-700 px-2 py-1 rounded text-sm font-semibold hover:bg-gray-400 transition-colors" data-lang="en">EN</button>
                <button id="lang-ja" class="lang-btn bg-blue-500 text-white px-2 py-1 rounded text-sm font-semibold hover:bg-blue-600 transition-colors" data-lang="ja">JP</button>
            </div>
        </header>

        <main class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
            <!-- Controles de Dificuldade -->
            <div class="flex flex-wrap gap-2 sm:gap-4 justify-center mb-4 items-center">
                <div class="flex items-center gap-1 sm:gap-2 flex-wrap justify-center">
                    <span id="difficulty-label" class="font-semibold">Dificuldade:</span>
                    <button data-difficulty="easy"
                        class="btn-difficulty border-2 border-gray-300 px-2 py-1 rounded-md text-xs sm:text-sm font-medium transition-colors hover:bg-blue-100"
                        data-lang-key="easy">F√°cil</button>
                    <button data-difficulty="medium"
                        class="btn-difficulty border-2 border-gray-300 px-2 py-1 rounded-md text-xs sm:text-sm font-medium transition-colors hover:bg-blue-100 active"
                        data-lang-key="medium">M√©dio</button>
                    <button data-difficulty="hard"
                        class="btn-difficulty border-2 border-gray-300 px-2 py-1 rounded-md text-xs sm:text-sm font-medium transition-colors hover:bg-blue-100"
                        data-lang-key="hard">Dif√≠cil</button>
                    <button data-difficulty="expert"
                        class="btn-difficulty border-2 border-gray-300 px-2 py-1 rounded-md text-xs sm:text-sm font-medium transition-colors hover:bg-blue-100"
                        data-lang-key="expert">Dific√≠limo</button>
                    <button data-difficulty="insane"
                        class="btn-difficulty border-2 border-gray-300 px-2 py-1 rounded-md text-xs sm:text-sm font-medium transition-colors hover:bg-blue-100"
                        data-lang-key="insane">Dific√≠limo Mesmo</button>
                </div>
            </div>

            <!-- Controles de A√ß√£o -->
            <div class="flex flex-wrap gap-2 sm:gap-4 justify-center mb-4 game-controls">
                <button id="new-game-btn"
                    class="bg-blue-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-700 transition-transform transform hover:scale-105"
                    data-lang-key="newGame">Novo Jogo</button>
                <button id="reset-btn"
                    class="bg-gray-500 text-white px-4 py-2 rounded-md font-semibold hover:bg-gray-600 transition-transform transform hover:scale-105"
                    data-lang-key="reset">Limpar</button>
                <button id="notes-btn"
                    class="btn-action bg-purple-500 text-white px-4 py-2 rounded-md font-semibold hover:bg-purple-600 transition-transform transform hover:scale-105"
                    data-lang-key="notes">üìù Notas</button>
                <button id="hint-btn"
                    class="btn-action bg-green-500 text-white px-4 py-2 rounded-md font-semibold hover:bg-green-600 transition-transform transform hover:scale-105"
                    data-lang-key="hint">Dica (3)</button>
                <button id="show-answer-btn"
                    class="btn-action bg-yellow-500 text-white px-4 py-2 rounded-md font-semibold hover:bg-yellow-600 transition-transform transform hover:scale-105"
                    data-lang-key="showAnswer">Resposta</button>
            </div>

            <!-- Canvas do Jogo -->
            <div class="canvas-container mx-auto relative">
                <canvas id="sudoku-canvas"></canvas>
                <div id="loader-container"
                    class="absolute inset-0 bg-white bg-opacity-80 flex items-center justify-center hidden">
                    <div id="loader"></div>
                </div>
            </div>
            <!-- Painel de N√∫meros para Mobile -->
            <div id="number-panel" class="grid grid-cols-10 gap-1 mt-4">
                <button data-num="1"
                    class="num-btn bg-gray-200 p-2 rounded-md text-xl font-bold hover:bg-blue-200 aspect-square flex items-center justify-center">1</button>
                <button data-num="2"
                    class="num-btn bg-gray-200 p-2 rounded-md text-xl font-bold hover:bg-blue-200 aspect-square flex items-center justify-center">2</button>
                <button data-num="3"
                    class="num-btn bg-gray-200 p-2 rounded-md text-xl font-bold hover:bg-blue-200 aspect-square flex items-center justify-center">3</button>
                <button data-num="4"
                    class="num-btn bg-gray-200 p-2 rounded-md text-xl font-bold hover:bg-blue-200 aspect-square flex items-center justify-center">4</button>
                <button data-num="5"
                    class="num-btn bg-gray-200 p-2 rounded-md text-xl font-bold hover:bg-blue-200 aspect-square flex items-center justify-center">5</button>
                <button data-num="6"
                    class="num-btn bg-gray-200 p-2 rounded-md text-xl font-bold hover:bg-blue-200 aspect-square flex items-center justify-center">6</button>
                <button data-num="7"
                    class="num-btn bg-gray-200 p-2 rounded-md text-xl font-bold hover:bg-blue-200 aspect-square flex items-center justify-center">7</button>
                <button data-num="8"
                    class="num-btn bg-gray-200 p-2 rounded-md text-xl font-bold hover:bg-blue-200 aspect-square flex items-center justify-center">8</button>
                <button data-num="9"
                    class="num-btn bg-gray-200 p-2 rounded-md text-xl font-bold hover:bg-blue-200 aspect-square flex items-center justify-center">9</button>
                <button data-num="0"
                    class="num-btn bg-red-200 p-2 rounded-md text-xl font-bold hover:bg-red-300 aspect-square flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M3 12l6.414 6.414a2 2 0 002.828 0L21 12M3 12l6.414-6.414a2 2 0 012.828 0L21 12" />
                    </svg>
                </button>
            </div>
        </main>

        <!-- Modal de Vit√≥ria -->
        <div id="win-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white p-8 rounded-lg shadow-2xl text-center transform transition-all scale-95">
                <h2 id="win-title" class="text-3xl font-bold text-yellow-500 mb-2">Parab√©ns!</h2>
                <p id="win-subtitle" class="text-lg text-gray-700 mb-6">Voc√™ completou o Sudoku!</p>
                <button id="modal-new-game-btn"
                    class="bg-blue-600 text-white px-6 py-2 rounded-md font-semibold hover:bg-blue-700 transition-transform transform hover:scale-105"
                    data-lang-key="playAgain">Jogar Novamente</button>
            </div>
        </div>

        <!-- Modal de Confirma√ß√£o para Mostrar Resposta -->
        <div id="confirm-modal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white p-8 rounded-lg shadow-2xl text-center transform transition-all scale-95">
                <h2 id="confirm-title" class="text-2xl font-bold text-gray-800 mb-4">Mostrar Resposta?</h2>
                <p id="confirm-subtitle" class="text-gray-600 mb-6">Isso preencher√° todo o tabuleiro e encerrar√° o jogo
                    atual. Voc√™ tem certeza?</p>
                <div class="flex justify-center gap-4">
                    <button id="confirm-cancel-btn"
                        class="bg-gray-300 text-gray-800 px-6 py-2 rounded-md font-semibold hover:bg-gray-400"
                        data-lang-key="cancel">Cancelar</button>
                    <button id="confirm-show-btn"
                        class="bg-red-600 text-white px-6 py-2 rounded-md font-semibold hover:bg-red-700"
                        data-lang-key="confirm">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- M√ìDULO DE TRADU√á√ÉO ---
        const translations = {
            en: {
                mainTitle: "Sudoku Game",
                subtitle: "Challenge your logic and have fun!",
                difficultyLabel: "Difficulty:",
                easy: "Easy",
                medium: "Medium",
                hard: "Hard",
                expert: "Expert",
                insane: "Insane",
                newGame: "New Game",
                reset: "Reset",
                hint: "Hint",
                notes: "Notes",
                notesActive: "Notes Mode",
                showAnswer: "Answer",
                winTitle: "Congratulations!",
                winSubtitle: "You have completed the Sudoku!",
                playAgain: "Play Again",
                confirmTitle: "Show Answer?",
                confirmSubtitle: "This will fill the entire board and end the current game. Are you sure?",
                cancel: "Cancel",
                confirm: "Confirm",
                langToggle: "JP"
            },
            pt: {
                mainTitle: "Jogo de Sudoku",
                subtitle: "Desafie sua l√≥gica e divirta-se!",
                difficultyLabel: "Dificuldade:",
                easy: "F√°cil",
                medium: "M√©dio",
                hard: "Dif√≠cil",
                expert: "Dific√≠limo",
                insane: "Dific√≠limo Mesmo",
                newGame: "Novo Jogo",
                reset: "Limpar",
                hint: "Dica",
                notes: "Notas",
                notesActive: "Modo Notas",
                showAnswer: "Resposta",
                winTitle: "Parab√©ns!",
                winSubtitle: "Voc√™ completou o Sudoku!",
                playAgain: "Jogar Novamente",
                confirmTitle: "Mostrar Resposta?",
                confirmSubtitle: "Isso preencher√° todo o tabuleiro e encerrar√° o jogo atual. Voc√™ tem certeza?",
                cancel: "Cancelar",
                confirm: "Confirmar",
                langToggle: "EN"
            },
            ja: {
                mainTitle: "Êï∞Áã¨„Ç≤„Éº„É†„ÄÄÔºàÊØç„Å°„ÇÉ„ÇìÁî®Ôºâ",
                subtitle: "Ë´ñÁêÜ„Å´ÊåëÊà¶„Åó„Å¶Ê•Ω„Åó„Çì„Åß„Åè„Å†„Åï„ÅÑÔºÅ",
                difficultyLabel: "Èõ£ÊòìÂ∫¶:",
                easy: "Á∞°Âçò",
                medium: "‰∏≠Á¥ö",
                hard: "Èõ£„Åó„ÅÑ",
                expert: "„Ç®„Ç≠„Çπ„Éë„Éº„Éà",
                insane: "Ë∂ÖÈõ£Èñ¢„ÄÄ„ÄêÁúüÂºìÁî®Ôºâ",
                newGame: "Êñ∞„Åó„ÅÑ„Ç≤„Éº„É†",
                reset: "„É™„Çª„ÉÉ„Éà",
                hint: "„Éí„É≥„Éà",
                notes: "„É°„É¢",
                notesActive: "„É°„É¢„É¢„Éº„Éâ",
                showAnswer: "Á≠î„Åà",
                winTitle: "„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ",
                winSubtitle: "Êï∞Áã¨„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„ÅüÔºÅ",
                playAgain: "„ÇÇ„ÅÜ‰∏ÄÂ∫¶„Éó„É¨„Ç§",
                confirmTitle: "Á≠î„Åà„ÇíË°®Á§∫„Åó„Åæ„Åô„ÅãÔºü",
                confirmSubtitle: "„Åì„Çå„Å´„Çà„Çä„ÄÅ„Åô„Åπ„Å¶„ÅÆ„Éû„Çπ„ÅåÂüã„ÇÅ„Çâ„Çå„ÄÅÁèæÂú®„ÅÆ„Ç≤„Éº„É†„ÅØÁµÇ‰∫Ü„Åó„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü",
                cancel: "„Ç≠„É£„É≥„Çª„É´",
                confirm: "Á¢∫Ë™ç",
                langToggle: "PT"
            }
        };

        let currentLang = 'ja'; // Japon√™s como padr√£o

        function updateUIText() {
            document.body.className = document.body.className.replace(/lang-\w+/g, '');
            document.body.classList.add(`lang-${currentLang}`);

            const t = translations[currentLang];
            document.getElementById('main-title').textContent = t.mainTitle;
            document.getElementById('subtitle').textContent = t.subtitle;
            document.getElementById('difficulty-label').textContent = t.difficultyLabel;
            document.querySelector('[data-difficulty="easy"]').textContent = t.easy;
            document.querySelector('[data-difficulty="medium"]').textContent = t.medium;
            document.querySelector('[data-difficulty="hard"]').textContent = t.hard;
            document.querySelector('[data-difficulty="expert"]').textContent = t.expert;
            document.querySelector('[data-difficulty="insane"]').textContent = t.insane;
            document.getElementById('new-game-btn').textContent = t.newGame;
            document.getElementById('reset-btn').textContent = t.reset;
            document.getElementById('show-answer-btn').textContent = t.showAnswer;
            document.getElementById('win-title').textContent = t.winTitle;
            document.getElementById('win-subtitle').textContent = t.winSubtitle;
            document.getElementById('modal-new-game-btn').textContent = t.playAgain;
            document.getElementById('confirm-title').textContent = t.confirmTitle;
            document.getElementById('confirm-subtitle').textContent = t.confirmSubtitle;
            document.getElementById('confirm-cancel-btn').textContent = t.cancel;
            document.getElementById('confirm-show-btn').textContent = t.confirm;
            
            // Atualizar bot√µes de idioma
            updateLanguageButtons();
        }

        function updateLanguageButtons() {
            const langButtons = document.querySelectorAll('.lang-btn');
            langButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === currentLang) {
                    btn.classList.add('active');
                }
            });
        }

        function setLanguage(lang) {
            currentLang = lang;
            updateUIText();
        }

        // --- M√ìDULO: GERADOR DE PUZZLE ---
        class SudokuGenerator {
            constructor() { this.grid = this.createEmptyGrid(); }
            createEmptyGrid() { return Array(9).fill(0).map(() => Array(9).fill(0)); }
            generate(difficulty) {
                this.grid = this.createEmptyGrid();
                this._fillGrid(this.grid);
                const solution = this.grid.map(row => [...row]);
                this._removeNumbers(this.grid, difficulty);
                return { puzzle: this.grid, solution: solution };
            }
            _fillGrid(grid) {
                let numbers = [1, 2, 3, 4, 5, 6, 7, 8, 9];
                let find = this._findEmpty(grid);
                if (!find) return true;
                let [row, col] = find;
                this._shuffle(numbers);
                for (let num of numbers) {
                    if (this._isValid(grid, row, col, num)) {
                        grid[row][col] = num;
                        if (this._fillGrid(grid)) return true;
                        grid[row][col] = 0;
                    }
                }
                return false;
            }
            _removeNumbers(grid, difficulty) {
                const removals = { easy: 40, medium: 50, hard: 56, expert: 61, insane: 64 }[difficulty];
                let count = removals;
                while (count > 0) {
                    let row = Math.floor(Math.random() * 9);
                    let col = Math.floor(Math.random() * 9);
                    if (grid[row][col] !== 0) {
                        grid[row][col] = 0;
                        count--;
                    }
                }
            }
            _isValid(grid, row, col, num) {
                for (let i = 0; i < 9; i++) {
                    if (grid[row][i] === num) return false;
                    if (grid[i][col] === num) return false;
                }
                const startRow = Math.floor(row / 3) * 3;
                const startCol = Math.floor(col / 3) * 3;
                for (let i = 0; i < 3; i++) for (let j = 0; j < 3; j++) if (grid[startRow + i][startCol + j] === num) return false;
                return true;
            }
            _findEmpty(grid) {
                for (let r = 0; r < 9; r++) for (let c = 0; c < 9; c++) if (grid[r][c] === 0) return [r, c];
                return null;
            }
            _shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }
        }

        // --- M√ìDULO: VALIDADOR ---
        class Validator {
            isMoveValid(board, row, col, num) {
                for (let i = 0; i < 9; i++) {
                    if (board[row][i] === num && i !== col) return false;
                    if (board[i][col] === num && i !== row) return false;
                }
                const startRow = Math.floor(row / 3) * 3;
                const startCol = Math.floor(col / 3) * 3;
                for (let i = 0; i < 3; i++) for (let j = 0; j < 3; j++) if (board[startRow + i][startCol + j] === num && (startRow + i !== row || startCol + j !== col)) return false;
                return true;
            }
        }

        // --- M√ìDULO: JOGO ---
        class SudokuGame {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.loader = document.getElementById('loader-container');
                this.hintBtn = document.getElementById('hint-btn');
                this.notesBtn = document.getElementById('notes-btn');
                this.difficulty = 'medium';
                this.validator = new Validator();
                this.generator = new SudokuGenerator();
                this.selected = { row: -1, col: -1 };
                this.boardSize = 0;
                this.cellSize = 0;
                
                // Sistema de notas
                this.isNotesMode = false;
                this.notes = new Map(); // Armazena notas para cada c√©lula (row*9+col)
                
                this.init();
            }

            init() {
                this.setupCanvas();
                this.startNewGame();
                this.addEventListeners();
                window.addEventListener('resize', () => this.resizeAndDraw());
            }

            setupCanvas() {
                const container = this.canvas.parentElement;
                const size = container.clientWidth;
                this.canvas.width = size;
                this.canvas.height = size;
                this.boardSize = size;
                this.cellSize = this.boardSize / 9;
            }

            startNewGame() {
                this.showLoader();
                setTimeout(() => {
                    const { puzzle, solution } = this.generator.generate(this.difficulty);
                    this.initialBoard = puzzle;
                    this.solution = solution;
                    this.playerBoard = this.initialBoard.map(row => [...row]);
                    this.conflicts = this.createEmptyGrid(false);
                    this.selected = { row: -1, col: -1 };
                    this.hintsLeft = 3;
                    
                    // Limpar notas
                    this.notes.clear();
                    this.isNotesMode = false;
                    this.updateNotesButton();
                    
                    this.updateHintButton();
                    this.updateConflicts();
                    this.draw();
                    this.hideLoader();
                }, 50);
            }

            resetBoard() {
                if (!this.initialBoard) return;
                this.playerBoard = this.initialBoard.map(row => [...row]);
                
                // Limpar notas no reset tamb√©m
                this.notes.clear();
                
                this.updateConflicts();
                this.draw();
            }

            showLoader() { this.loader.classList.remove('hidden'); }
            hideLoader() { this.loader.classList.add('hidden'); }
            createEmptyGrid(initialValue) { return Array(9).fill(0).map(() => Array(9).fill(initialValue)); }

            addEventListeners() {
                this.canvas.addEventListener('click', this.handleCanvasClick.bind(this));
                this.canvas.addEventListener('touchstart', this.handleCanvasClick.bind(this), { passive: true });
                window.addEventListener('keydown', this.handleKeyDown.bind(this));
                this.hintBtn.addEventListener('click', this.useHint.bind(this));
            }

            handleCanvasClick(e) {
                const rect = this.canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                const x = clientX - rect.left;
                const y = clientY - rect.top;
                const col = Math.floor(x / this.cellSize);
                const row = Math.floor(y / this.cellSize);
                if (col >= 0 && col < 9 && row >= 0 && row < 9) {
                    this.selected = { row, col };
                    this.draw();
                }
            }

            handleKeyDown(e) {
                if (this.selected.row === -1) return;
                if (e.key >= '1' && e.key <= '9') {
                    if (e.shiftKey) {
                        // Shift + n√∫mero = modo notas
                        const wasNotesMode = this.isNotesMode;
                        this.isNotesMode = true;
                        this.placeNumber(this.selected.row, this.selected.col, parseInt(e.key));
                        this.isNotesMode = wasNotesMode;
                    } else {
                        this.placeNumber(this.selected.row, this.selected.col, parseInt(e.key));
                    }
                } else if (e.key === 'Backspace' || e.key === 'Delete') {
                    this.placeNumber(this.selected.row, this.selected.col, 0);
                } else if (e.key.startsWith('Arrow')) {
                    e.preventDefault();
                    let { row, col } = this.selected;
                    if (e.key === 'ArrowUp' && row > 0) row--;
                    else if (e.key === 'ArrowDown' && row < 8) row++;
                    else if (e.key === 'ArrowLeft' && col > 0) col--;
                    else if (e.key === 'ArrowRight' && col < 8) col++;
                    this.selected = { row, col };
                    this.draw();
                }
            }

            placeNumber(row, col, num) {
                if (row === -1 || (this.initialBoard && this.initialBoard[row][col] !== 0)) return;
                
                if (this.isNotesMode && num > 0) {
                    // Modo notas - adicionar/remover nota
                    this.toggleNote(row, col, num);
                } else {
                    // Modo normal - colocar n√∫mero
                    this.playerBoard[row][col] = num;
                    // Limpar notas da c√©lula quando um n√∫mero √© colocado
                    if (num > 0) {
                        this.clearCellNotes(row, col);
                    }
                }
                
                this.updateConflicts();
                this.draw();
                this.checkWinCondition();
            }

            useHint() {
                if (this.hintsLeft <= 0) return;
                const emptyCells = [];
                for (let r = 0; r < 9; r++) for (let c = 0; c < 9; c++) if (this.playerBoard[r][c] === 0) emptyCells.push({ r, c });
                if (emptyCells.length > 0) {
                    const randomCell = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                    const { r, c } = randomCell;
                    const correctNumber = this.solution[r][c];
                    this.placeNumber(r, c, correctNumber);
                    this.hintsLeft--;
                    this.updateHintButton();
                }
            }

            updateHintButton() {
                this.hintBtn.textContent = `${translations[currentLang].hint} (${this.hintsLeft})`;
                this.hintBtn.disabled = this.hintsLeft <= 0;
            }

            // M√©todos do sistema de notas
            toggleNotesMode() {
                this.isNotesMode = !this.isNotesMode;
                this.updateNotesButton();
            }

            updateNotesButton() {
                this.notesBtn.classList.toggle('notes-active', this.isNotesMode);
                
                const t = translations[currentLang];
                if (this.isNotesMode) {
                    this.notesBtn.style.backgroundColor = '#7c3aed';
                    this.notesBtn.textContent = `üìù ${t.notesActive}`;
                } else {
                    this.notesBtn.style.backgroundColor = '#8b5cf6';
                    this.notesBtn.textContent = `üìù ${t.notes}`;
                }
            }

            toggleNote(row, col, num) {
                if (this.playerBoard[row][col] !== 0) return; // N√£o pode adicionar notas em c√©lulas preenchidas
                
                const cellKey = row * 9 + col;
                if (!this.notes.has(cellKey)) {
                    this.notes.set(cellKey, new Set());
                }
                
                const cellNotes = this.notes.get(cellKey);
                if (cellNotes.has(num)) {
                    cellNotes.delete(num);
                } else {
                    cellNotes.add(num);
                }
                
                // Remove notas vazias
                if (cellNotes.size === 0) {
                    this.notes.delete(cellKey);
                }
            }

            clearCellNotes(row, col) {
                const cellKey = row * 9 + col;
                this.notes.delete(cellKey);
            }

            showAnswer() {
                this.playerBoard = this.solution.map(row => [...row]);
                this.updateConflicts();
                this.draw();
            }

            updateConflicts() {
                this.conflicts = this.createEmptyGrid(false);
                for (let r = 0; r < 9; r++) for (let c = 0; c < 9; c++) if (this.playerBoard[r][c] !== 0) if (!this.validator.isMoveValid(this.playerBoard, r, c, this.playerBoard[r][c])) this.conflicts[r][c] = true;
            }

            checkWinCondition() {
                for (let r = 0; r < 9; r++) for (let c = 0; c < 9; c++) if (this.playerBoard[r][c] === 0 || this.conflicts[r][c]) return;
                this.showWinModal();
            }

            showWinModal() {
                const modal = document.getElementById('win-modal');
                modal.classList.remove('hidden');
                setTimeout(() => modal.querySelector('div').classList.remove('scale-95'), 10);
            }

            showConfirmModal() {
                const modal = document.getElementById('confirm-modal');
                modal.classList.remove('hidden');
                setTimeout(() => modal.querySelector('div').classList.remove('scale-95'), 10);
            }

            hideConfirmModal() {
                const modal = document.getElementById('confirm-modal');
                modal.querySelector('div').classList.add('scale-95')
                setTimeout(() => modal.classList.add('hidden'), 150);
            }

            draw() {
                this.ctx.clearRect(0, 0, this.boardSize, this.boardSize);
                this.drawHighlights();
                this.drawGrid();
                this.drawNumbers();
            }

            drawGrid() {
                this.ctx.strokeStyle = '#9CA3AF';
                for (let i = 0; i <= 9; i++) {
                    this.ctx.lineWidth = (i % 3 === 0) ? 3 : 1;
                    this.ctx.beginPath(); this.ctx.moveTo(i * this.cellSize, 0); this.ctx.lineTo(i * this.cellSize, this.boardSize); this.ctx.stroke();
                    this.ctx.beginPath(); this.ctx.moveTo(0, i * this.cellSize); this.ctx.lineTo(this.boardSize, i * this.cellSize); this.ctx.stroke();
                }
            }

            drawHighlights() {
                if (this.selected.row === -1) return;
                const { row, col } = this.selected;
                const x = col * this.cellSize; const y = row * this.cellSize;
                this.ctx.fillStyle = '#EBF4FF';
                this.ctx.fillRect(0, y, this.boardSize, this.cellSize);
                this.ctx.fillRect(x, 0, this.cellSize, this.boardSize);
                const startRow = Math.floor(row / 3) * 3; const startCol = Math.floor(col / 3) * 3;
                this.ctx.fillRect(startCol * this.cellSize, startRow * this.cellSize, this.cellSize * 3, this.cellSize * 3);
                this.ctx.fillStyle = '#BFDBFE';
                this.ctx.fillRect(x, y, this.cellSize, this.cellSize);
            }

            drawNumbers() {
                // Primeiro desenha as notas em c√©lulas vazias
                for (let r = 0; r < 9; r++) {
                    for (let c = 0; c < 9; c++) {
                        if (this.playerBoard[r][c] === 0) {
                            this.drawCellNotes(r, c);
                        }
                    }
                }
                
                // Depois desenha os n√∫meros por cima das notas
                const fontSize = this.cellSize * 0.6;
                this.ctx.font = `bold ${fontSize}px 'Inter', 'Noto Sans JP', sans-serif`;
                this.ctx.textAlign = 'center'; 
                this.ctx.textBaseline = 'middle';
                
                for (let r = 0; r < 9; r++) {
                    for (let c = 0; c < 9; c++) {
                        const num = this.playerBoard[r][c];
                        if (num !== 0) {
                            const x = c * this.cellSize + this.cellSize / 2;
                            const y = r * this.cellSize + this.cellSize / 2;
                            
                            // Cores diferentes para diferentes tipos de n√∫meros
                            if (this.conflicts[r][c]) {
                                this.ctx.fillStyle = '#EF4444'; // Vermelho para conflitos
                            } else if (this.initialBoard[r][c] !== 0) {
                                this.ctx.fillStyle = '#000000'; // Preto para n√∫meros do jogo original
                            } else {
                                this.ctx.fillStyle = '#1E3A8A'; // Azul escuro para n√∫meros do jogador
                            }
                            this.ctx.fillText(num.toString(), x, y);
                        }
                    }
                }
            }

            drawCellNotes(row, col) {
                const cellKey = row * 9 + col;
                const cellNotes = this.notes.get(cellKey);
                
                if (!cellNotes || cellNotes.size === 0) return;
                
                const noteSize = this.cellSize * 0.22;
                this.ctx.font = `${noteSize}px 'Inter', sans-serif`;
                this.ctx.fillStyle = '#F97316'; // Laranja para notas
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                
                // Grid 3x3 para as notas dentro da c√©lula
                const cellX = col * this.cellSize;
                const cellY = row * this.cellSize;
                const noteSpacing = this.cellSize / 3;
                
                for (let note of cellNotes) {
                    const noteRow = Math.floor((note - 1) / 3);
                    const noteCol = (note - 1) % 3;
                    const noteX = cellX + noteCol * noteSpacing + noteSpacing / 2;
                    const noteY = cellY + noteRow * noteSpacing + noteSpacing / 2;
                    
                    this.ctx.fillText(note.toString(), noteX, noteY);
                }
            }

            resizeAndDraw() { this.setupCanvas(); this.draw(); }
        }

        // --- PONTO DE ENTRADA DA APLICA√á√ÉO ---
        document.addEventListener('DOMContentLoaded', () => {
            const game = new SudokuGame('sudoku-canvas');

            // --- Event Listeners dos Controles ---
            document.querySelectorAll('.btn-difficulty').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.btn-difficulty').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    game.difficulty = btn.dataset.difficulty;
                    game.startNewGame();
                });
            });

            document.getElementById('new-game-btn').addEventListener('click', () => game.startNewGame());
            document.getElementById('reset-btn').addEventListener('click', () => game.resetBoard());
            document.getElementById('notes-btn').addEventListener('click', () => game.toggleNotesMode());

            document.getElementById('modal-new-game-btn').addEventListener('click', () => {
                document.getElementById('win-modal').classList.add('hidden');
                game.startNewGame();
            });

            document.querySelectorAll('.num-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (game.selected.row !== -1) {
                        const num = parseInt(btn.dataset.num);
                        game.placeNumber(game.selected.row, game.selected.col, num);
                    }
                });
            });

            // L√≥gica do Modal de Confirma√ß√£o
            document.getElementById('show-answer-btn').addEventListener('click', () => game.showConfirmModal());
            document.getElementById('confirm-cancel-btn').addEventListener('click', () => game.hideConfirmModal());
            document.getElementById('confirm-show-btn').addEventListener('click', () => {
                game.showAnswer();
                game.hideConfirmModal();
            });

            // L√≥gica dos Seletores de Idioma
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    setLanguage(btn.dataset.lang);
                    game.updateHintButton();
                    game.updateNotesButton();
                });
            });

            // Inicia a UI com o idioma padr√£o
            updateUIText();
        });

    </script>
</body>

</html>